<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Hello 2d World</title>
    <style>
      html, body, #map-div {
        margin: 0;
        padding: 0;
        height: 100%;
      }
    </style>

    <script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <script src="CanvasLayer.js"></script>

    <script>
      var map;
      var canvasLayer;
      var context;

      var rectLatLng = new google.maps.LatLng(37.7080, -122.5287);
      var rectLatLng2 = new google.maps.LatLng(37.8249, -122.3494);

      function init() {
        // initialize the map
        var mapOptions = {
          zoom: 9,
          center: new google.maps.LatLng(37.75, -122.45),
          mapTypeId: google.maps.MapTypeId.ROADMAP,
        };
        var mapDiv = document.getElementById('map-div');
        map = new google.maps.Map(mapDiv, mapOptions);

        // initialize the canvasLayer
        var canvasLayerOptions = {
          map: map,
          resizeHandler: resize,
          animate: false,
          updateHandler: update
        };
        canvasLayer = new CanvasLayer(canvasLayerOptions);
        context = canvasLayer.canvas.getContext('2d');
      }

      function resize() {
        // nothing to do here
      }

      function update() {
        // clear previous canvas contents
        var canvasWidth = canvasLayer.canvas.width;
        var canvasHeight = canvasLayer.canvas.height;
        context.clearRect(0, 0, canvasWidth, canvasHeight);

        // we like our rectangles green
        context.fillStyle = 'rgba(0, 255, 0, .5)';
        
        /* We need to scale and translate the map for current view.
         * see https://developers.google.com/maps/documentation/javascript/maptypes#MapCoordinates
         */
        var mapProjection = map.getProjection();

        /**
         * Clear transformation from last update by setting to identity matrix.
         * Could use context.resetTransform(), but most browsers don't support
         * it yet.
         */
        context.setTransform(1, 0, 0, 1, 0, 0);
        
        // scale is just 2^zoom
        var scale = Math.pow(2, map.zoom);
        context.scale(scale, scale);

        /* If the map was not translated, the topLeft corner would be 0,0 in
         * world coordinates. Our translation is just the vector from the
         * world coordinate of the topLeft corder to 0,0.
         */
        var offset = mapProjection.fromLatLngToPoint(canvasLayer.getTopLeft());
        context.translate(-offset.x, -offset.y);

        // project rectLatLng to world coordinates and draw
        var worldPoint = mapProjection.fromLatLngToPoint(rectLatLng);
        var worldPoint2 = mapProjection.fromLatLngToPoint(rectLatLng2);

	var width = worldPoint2.x - worldPoint.x;
	var height = worldPoint2.y - worldPoint.y;

	context.save();
	context.globalAlpha = .5;
	context.translate(worldPoint.x, worldPoint.y);
	// context.rotate(Math.PI / 5);
	context.drawImage(document.getElementById("map-img"),
        	0, 0,
		worldPoint2.x - worldPoint.x, worldPoint2.y - worldPoint.y);
	context.restore();
        //context.fillRect(worldPoint.x, worldPoint.y,
	//	worldPoint2.x - worldPoint.x, worldPoint2.y - worldPoint.y);
      }

      document.addEventListener('DOMContentLoaded', init, false);
    </script>
  </head>

  <body>
    <div style="display: none">
    <!--
    <img id="map-img" src="http://farm9.staticflickr.com/8531/8577894099_b757549173_b.jpg"/>
    -->
    <img id="map-img" src="http://farm3.staticflickr.com/2675/4090651102_877c582129_b.jpg"/>
    </div>
    <div id="map-div"></div>
  </body>
</html>
